<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>WhatsApp-style Chat Room</title>
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

  <style>
    :root {
      --primary-white: #ffffff;
      --secondary-purple: #6a5acd;
      --light-purple: #9370db;
      --dark-purple: #4b0082;
    }
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0;
      display: flex;
      flex-direction: column;
      height: 100vh;
      background-color: var(--primary-white);
      overflow-x: hidden;
    }
    #call-button {
      padding: 15px;
      border: none;
      border-radius: 15px;
      background-color: var(--secondary-purple);
      color: var(--primary-white);
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      gap: 10px;
    }
    #title {
      flex: 1;
      color: white;
      position: relative;
      left: 50%;
      transform: translateX(-50%);
      margin: 0;
    }
    #top-bar {
      background-color: var(--secondary-purple);
      display: flex;
      justify-content: center;
      align-items: center;
    }
    #chat-container {
      flex: 1;
      overflow-y: auto;
      padding: 10px;
      margin-top: 60px;
      margin-bottom: 60px;
    }
    .message {
      max-width: 70%;
      word-wrap: break-word;
      position: relative;
      margin-bottom: 10px;
      padding: 10px;
      border-radius: 10px;
      display: inline-block;
      clear: both;
    }
    .message.sent {
      float: right;
      padding-right: 40px;
      border: var(--light-purple) 2px solid;
      color: black;
    }
    .message.received {
      background-color: var(--light-purple);
      float: left;
      padding-right: 40px;
      color: white;
    }
    .message-input {
      display: flex;
      padding: 10px;
      background-color: #f0f0f0;
      border-top: 1px solid #ccc;
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      height: 40px;
    }
    #message-text {
      flex: 1;
      padding: 5px 10px;
      border: 1px solid #ccc;
      border-radius: 20px;
      margin-right: 10px;
      font-size: 16px;
    }
    #send-button {
      background-color: var(--secondary-purple);
      color: white;
      border: none;
      padding: 5px 15px;
      border-radius: 20px;
      cursor: pointer;
      font-size: 14px;
    }
    .date-separator {
      text-align: center;
      margin: 20px 0;
      color: #888;
      font-size: 12px;
      clear: both;
    }
    .message-author {
      font-weight: bold;
      font-size: 13px;
      margin-bottom: 2px;
      color: black;
    }
    .message-content {
      margin-bottom: 15px;
      font-size: 14px;
    }
    /* Footer for time + status icon */
    .message-footer {
      position: absolute;
      bottom: 3px;
      right: 7px;
      display: flex;
      align-items: center;
      gap: 5px; /* space between time and icon */
      white-space: nowrap;
    }
    .message-time {
      font-size: 11px;
      color: #888;
    }
    .message-status-icon {
      font-size: 12px;
      color: #888;
    }
    @media (max-width: 600px) {
      .message {
        max-width: 80%;
      }
    }
  </style>
</head>

<body>
  <div id="top-bar">
    <h5 id="title"></h5>
    <button id="call-button">Call</button>
  </div>
  <div id="chat-container"></div>
  <div class="message-input">
    <input type="text" id="message-text" placeholder="Type a message..." />
    <button id="send-button">Send</button>
  </div>

  <script>
    const controller = window.top.controller;
    const urlParams = new URLSearchParams(window.location.search);
    const channel = new BroadcastChannel('myChannel');
    const sessionId = decodeURIComponent(urlParams.get('sessionId'));

    const chatContainer = document.getElementById('chat-container');
    const messageText = document.getElementById('message-text');
    const sendButton = document.getElementById('send-button');

    controller.getMessages(sessionId, 10);

    function formatTime(timestamp) {
      const date = new Date(parseInt(timestamp));
      return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
    }

    function formatDate(timestamp) {
      const date = new Date(parseInt(timestamp));
      return date.toLocaleDateString();
    }

    let lastDisplayedDate = null;
    let lastAuthor = null;

    /**
     * Add a message to the chat UI.
     * @param {string} content - The message content.
     * @param {string} author - The author of the message.
     * @param {string|number} time - The timestamp of the message.
     * @param {string} [type='text'] - The message type (text, image, etc.).
     * @param {number} [status=null] - The status code of the message (0,1,2,4).
     */
    function addMessage(content, author, time, type = 'text', status = null) {
      const currentDate = formatDate(time);

      // Add date separator if new day
      if (currentDate !== lastDisplayedDate) {
        const dateElement = document.createElement('div');
        dateElement.classList.add('date-separator');
        dateElement.textContent = currentDate;
        chatContainer.appendChild(dateElement);
        lastDisplayedDate = currentDate;
      }

      // Create message element
      const messageElement = document.createElement('div');
      // We interpret "author === sessionId ? 'received' : 'sent'"
      // as: if it's from the user we're chatting with, it is "received".
      // If it's from me, it is "sent". Adjust logic as per your usage.
      messageElement.classList.add('message', author === sessionId ? 'received' : 'sent');

      // Show author if it's the first message in a series from them
      if (author === sessionId && author !== lastAuthor) {
        const authorElement = document.createElement('div');
        authorElement.classList.add('message-author');
        authorElement.textContent = author;
        messageElement.appendChild(authorElement);
      }

      // Message content
      if (type === 'text') {
        const contentElement = document.createElement('div');
        contentElement.classList.add('message-content');
        contentElement.textContent = content;
        messageElement.appendChild(contentElement);
      } else if (type === 'image') {
        messageElement.classList.add('image-message');
        const img = document.createElement('img');
        img.src = content;
        messageElement.appendChild(img);
      }

      // Footer container for time and possibly status icon
      const footerElement = document.createElement('div');
      footerElement.classList.add('message-footer');

      // Time element
      const timeElement = document.createElement('div');
      timeElement.classList.add('message-time');
      timeElement.textContent = formatTime(time);
      footerElement.appendChild(timeElement);

      // If outgoing message (class 'sent'), show status icon
      if (messageElement.classList.contains('sent') && status !== null) {
        const statusIcon = document.createElement('span');
        statusIcon.classList.add('material-icons', 'message-status-icon');

        // Map the numeric status to a Material Icon (adjust as you like)
        switch (status) {
          case 0:
            // e.g., pending to send
            statusIcon.textContent = 'schedule';
            break;
          case 1:
            // e.g., sent
            statusIcon.textContent = 'done';
            break;
          case 2:
            // e.g., delivered
            statusIcon.textContent = 'error';
            break;
          case 4:
            // e.g., error or read receipt
            statusIcon.textContent = 'done_all';
            break;
          default:
            statusIcon.textContent = '';
            break;
        }

        footerElement.appendChild(statusIcon);
      }

      messageElement.appendChild(footerElement);
      chatContainer.appendChild(messageElement);
      chatContainer.scrollTop = chatContainer.scrollHeight;

      lastAuthor = author;
    }

    // Set the chat title
    document.getElementById("title").textContent = sessionId;

    // Call button logic
    document.getElementById("call-button").addEventListener("click", () => {
      const connectRequest = {
        action: "call-attempt",
        body: { to: sessionId }
      };
      window.parent.parent.postMessage(connectRequest, '*');
    });

    // Send button logic
    sendButton.addEventListener('click', () => {
      const message = messageText.value.trim();
      if (message) {
        console.log("Sending message:", message);
        controller.sendMessage(sessionId, message);
        messageText.value = '';
      }
    });

    // Send on Enter key
    messageText.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        sendButton.click();
      }
    });

    // Close chat on back navigation
    window.addEventListener('popstate', function(event) {
      closeChat();
    });
    window.onpopstate = function(event) {
      closeChat();
    };
    function closeChat() {
      window.parent.postMessage({action: 'closeChat'}, '*');
    }

    // Listen for incoming messages or message history
    channel.addEventListener('message', (event) => {
      try {
        const data = typeof event.data === "string" ? JSON.parse(event.data) : event.data;
        
        // Single message scenario
        if (data.message) {
          console.log("Received single message data:", data.message);
          const [messageId, time, author, content, msgSessionId, msgStatus] = data.message;
          if (msgSessionId === sessionId) {
            addMessage(content, author, time, "text", msgStatus);
          }
        } 
        // Multiple messages scenario
        else if (data.messages) {
          data.messages.forEach(msg => {
            const [messageId, time, author, content, msgSessionId, msgStatus] = msg;
            if (msgSessionId === sessionId) {
              addMessage(content, author, time, "text", msgStatus);
            }
          });
        }
      } catch (error) {
        console.error("Error processing message data:", error);
      }
    });
  </script>
</body>
</html>
